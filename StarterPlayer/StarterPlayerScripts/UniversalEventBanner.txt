-- UniversalEventBanner.client.lua local script

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- ==== Configuration ====
local CONFIG = {
	COLORS = {
		global = {
			primary = Color3.fromRGB(139, 92, 246),
			secondary = Color3.fromRGB(168, 85, 247),
			glow = Color3.fromRGB(196, 181, 253)
		},
		local_event = {
			primary = Color3.fromRGB(59, 130, 246),
			secondary = Color3.fromRGB(37, 99, 235),
			glow = Color3.fromRGB(147, 197, 253)
		},
		announcement = {
			success = Color3.fromRGB(34, 197, 94),
			warning = Color3.fromRGB(251, 146, 60),
			error = Color3.fromRGB(239, 68, 68),
			info = Color3.fromRGB(59, 130, 246)
		}
	},
	ANIMATION_SPEED = 0.4,
	UPDATE_INTERVAL = 1
}

-- ==== Safe wait for Remotes ====
local function waitForRemotes(timeout)
	timeout = timeout or 10
	local t0 = os.clock()
	local rem = ReplicatedStorage:FindFirstChild("Remotes")
	while not rem and os.clock() - t0 < timeout do
		task.wait(0.1)
		rem = ReplicatedStorage:FindFirstChild("Remotes")
	end
	return rem
end

local Remotes = waitForRemotes(10)
if not Remotes then
	warn("[EventBanner] Remotes folder tidak ditemukan")
	return
end

local GetEventStatusRF = Remotes:FindFirstChild("GetEventStatus")
local EventChangedRE = Remotes:FindFirstChild("EventChanged")
local AnnouncementRE = Remotes:FindFirstChild("Announcement")

if not GetEventStatusRF or not EventChangedRE then
	warn("[EventBanner] Required remotes tidak ditemukan")
	return
end

-- ==== Helper Functions ====
local function cleanNum(n)
	n = tonumber(n) or 0
	if n == math.floor(n) then return tostring(n) end
	local s = string.format("%.2f", n)
	return s:gsub("0+$",""):gsub("%.$","")
end

local function formatTime(sec)
	if sec < 0 then sec = 0 end
	local h = math.floor(sec/3600)
	sec = sec % 3600
	local m = math.floor(sec/60)
	sec = sec % 60

	if h > 0 then
		return string.format("%dh %dm %ds", h, m, sec)
	elseif m > 0 then
		return string.format("%dm %ds", m, sec)
	else
		return string.format("%ds", sec)
	end
end

local function createCorner(parent, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius or 12)
	corner.Parent = parent
	return corner
end

local function createGradient(parent, color1, color2, rotation)
	local gradient = Instance.new("UIGradient")
	gradient.Color = ColorSequence.new(color1, color2)
	gradient.Rotation = rotation or 90
	gradient.Parent = parent
	return gradient
end

local function createStroke(parent, color, thickness, transparency)
	local stroke = Instance.new("UIStroke")
	stroke.Color = color or Color3.new(1, 1, 1)
	stroke.Thickness = thickness or 1
	stroke.Transparency = transparency or 0.7
	stroke.Parent = parent
	return stroke
end

-- ==== Main GUI ====
local gui = Instance.new("ScreenGui")
gui.Name = "EnhancedEventBannerUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- ==== Event Banner (Bottom) ====
local eventBanner = Instance.new("Frame")
eventBanner.Name = "EventBanner"
eventBanner.Size = UDim2.new(1, 0, 0, 50)
eventBanner.Position = UDim2.new(0, 0, 1, 50)
eventBanner.BackgroundColor3 = CONFIG.COLORS.local_event.primary
eventBanner.BackgroundTransparency = 0.1
eventBanner.BorderSizePixel = 0
eventBanner.Parent = gui

createCorner(eventBanner, 0)
local eventGradient = createGradient(eventBanner, CONFIG.COLORS.local_event.primary, CONFIG.COLORS.local_event.secondary, 45)
local eventStroke = createStroke(eventBanner, Color3.new(1, 1, 1), 2, 0.85)

-- Glow effect container
local glowContainer = Instance.new("Frame")
glowContainer.Size = UDim2.new(1, 0, 0, 2)
glowContainer.Position = UDim2.new(0, 0, 0, 0)
glowContainer.BackgroundColor3 = CONFIG.COLORS.local_event.glow
glowContainer.BackgroundTransparency = 0.3
glowContainer.BorderSizePixel = 0
glowContainer.Parent = eventBanner

-- Animated glow
local function animateGlow()
	local tween = TweenService:Create(glowContainer,
		TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true),
		{ BackgroundTransparency = 0.7 }
	)
	tween:Play()
	return tween
end

local glowTween = animateGlow()

-- Event icon
local eventIcon = Instance.new("TextLabel")
eventIcon.Size = UDim2.new(0, 40, 0, 40)
eventIcon.Position = UDim2.new(0, 15, 0.5, -20)
eventIcon.BackgroundColor3 = Color3.new(1, 1, 1)
eventIcon.BackgroundTransparency = 0.85
eventIcon.Text = "üéâ"
eventIcon.Font = Enum.Font.GothamBold
eventIcon.TextSize = 22
eventIcon.Parent = eventBanner
createCorner(eventIcon, 20)

-- Scope badge
local scopeBadge = Instance.new("Frame")
scopeBadge.Size = UDim2.new(0, 100, 0, 26)
scopeBadge.Position = UDim2.new(0, 65, 0.5, -13)
scopeBadge.BackgroundColor3 = Color3.new(1, 1, 1)
scopeBadge.BackgroundTransparency = 0.8
scopeBadge.Parent = eventBanner
createCorner(scopeBadge, 13)

local scopeLabel = Instance.new("TextLabel")
scopeLabel.Size = UDim2.new(1, 0, 1, 0)
scopeLabel.BackgroundTransparency = 1
scopeLabel.Text = "üñ•Ô∏è LOCAL"
scopeLabel.Font = Enum.Font.GothamBold
scopeLabel.TextSize = 12
scopeLabel.TextColor3 = Color3.new(1, 1, 1)
scopeLabel.Parent = scopeBadge

-- Multipliers
local multipliersContainer = Instance.new("Frame")
multipliersContainer.Size = UDim2.new(0, 250, 1, 0)
multipliersContainer.Position = UDim2.new(0, 180, 0, 0)
multipliersContainer.BackgroundTransparency = 1
multipliersContainer.Parent = eventBanner

local summitLabel = Instance.new("TextLabel")
summitLabel.Size = UDim2.new(0, 120, 0, 20)
summitLabel.Position = UDim2.new(0, 0, 0, 8)
summitLabel.BackgroundTransparency = 1
summitLabel.Text = "‚õ∞Ô∏è Summit x2.0"
summitLabel.Font = Enum.Font.GothamMedium
summitLabel.TextSize = 13
summitLabel.TextColor3 = Color3.new(1, 1, 1)
summitLabel.TextXAlignment = Enum.TextXAlignment.Left
summitLabel.Parent = multipliersContainer

local cashLabel = Instance.new("TextLabel")
cashLabel.Size = UDim2.new(0, 120, 0, 20)
cashLabel.Position = UDim2.new(0, 130, 0, 8)
cashLabel.BackgroundTransparency = 1
cashLabel.Text = "üí∞ Cash x1.5"
cashLabel.Font = Enum.Font.GothamMedium
cashLabel.TextSize = 13
cashLabel.TextColor3 = Color3.new(1, 1, 1)
cashLabel.TextXAlignment = Enum.TextXAlignment.Left
cashLabel.Parent = multipliersContainer

-- Timer
local timerContainer = Instance.new("Frame")
timerContainer.Size = UDim2.new(0, 150, 0, 30)
timerContainer.Position = UDim2.new(1, -165, 0.5, -15)
timerContainer.BackgroundColor3 = Color3.new(0, 0, 0)
timerContainer.BackgroundTransparency = 0.4
timerContainer.Parent = eventBanner
createCorner(timerContainer, 15)

local timerIcon = Instance.new("TextLabel")
timerIcon.Size = UDim2.new(0, 25, 1, 0)
timerIcon.Position = UDim2.new(0, 5, 0, 0)
timerIcon.BackgroundTransparency = 1
timerIcon.Text = "‚è±Ô∏è"
timerIcon.Font = Enum.Font.GothamBold
timerIcon.TextSize = 16
timerIcon.Parent = timerContainer

local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(1, -35, 1, 0)
timerLabel.Position = UDim2.new(0, 30, 0, 0)
timerLabel.BackgroundTransparency = 1
timerLabel.Text = "0h 0m 0s"
timerLabel.Font = Enum.Font.GothamBold
timerLabel.TextSize = 14
timerLabel.TextColor3 = Color3.new(1, 1, 1)
timerLabel.TextXAlignment = Enum.TextXAlignment.Left
timerLabel.Parent = timerContainer

-- Progress bar
local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0, 0, 0, 3)
progressBar.Position = UDim2.new(0, 0, 1, -3)
progressBar.BackgroundColor3 = Color3.new(1, 1, 1)
progressBar.BackgroundTransparency = 0.3
progressBar.BorderSizePixel = 0
progressBar.Parent = eventBanner

-- ==== Announcement Banner (Top) ====
local announcementBanner = Instance.new("Frame")
announcementBanner.Name = "AnnouncementBanner"
announcementBanner.Size = UDim2.new(1, 0, 0, 45)
announcementBanner.Position = UDim2.new(0, 0, 0, -45)
announcementBanner.BackgroundColor3 = CONFIG.COLORS.announcement.info
announcementBanner.BackgroundTransparency = 0.1
announcementBanner.BorderSizePixel = 0
announcementBanner.Parent = gui

createCorner(announcementBanner, 0)
local announcementGradient = createGradient(announcementBanner, CONFIG.COLORS.announcement.info, CONFIG.COLORS.announcement.info)
createStroke(announcementBanner, Color3.new(1, 1, 1), 2, 0.85)

local announcementIcon = Instance.new("TextLabel")
announcementIcon.Size = UDim2.new(0, 35, 0, 35)
announcementIcon.Position = UDim2.new(0, 10, 0.5, -17.5)
announcementIcon.BackgroundTransparency = 1
announcementIcon.Text = "üì¢"
announcementIcon.Font = Enum.Font.GothamBold
announcementIcon.TextSize = 20
announcementIcon.Parent = announcementBanner

local announcementLabel = Instance.new("TextLabel")
announcementLabel.Size = UDim2.new(1, -60, 1, 0)
announcementLabel.Position = UDim2.new(0, 50, 0, 0)
announcementLabel.BackgroundTransparency = 1
announcementLabel.Text = ""
announcementLabel.Font = Enum.Font.GothamMedium
announcementLabel.TextSize = 14
announcementLabel.TextColor3 = Color3.new(1, 1, 1)
announcementLabel.TextXAlignment = Enum.TextXAlignment.Left
announcementLabel.TextWrapped = true
announcementLabel.Parent = announcementBanner

-- ==== Animation Functions ====
local function slideEventIn()
	local tween = TweenService:Create(eventBanner,
		TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
		{ Position = UDim2.new(0, 0, 1, -50) }
	)
	tween:Play()
end

local function slideEventOut()
	local tween = TweenService:Create(eventBanner,
		TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
		{ Position = UDim2.new(0, 0, 1, 50) }
	)
	tween:Play()
end

local function slideAnnouncementIn()
	local tween = TweenService:Create(announcementBanner,
		TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
		{ Position = UDim2.new(0, 0, 0, 0) }
	)
	tween:Play()
end

local function slideAnnouncementOut()
	local tween = TweenService:Create(announcementBanner,
		TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
		{ Position = UDim2.new(0, 0, 0, -45) }
	)
	tween:Play()
end

-- ==== State Management ====
local eventState = {
	active = false,
	now = 0,
	["end"] = 0,
	start = 0,
	summitMult = 1,
	cashMult = 1,
	scope = "local"
}

local function updateColors(scope)
	local colors = (scope == "global") and CONFIG.COLORS.global or CONFIG.COLORS.local_event

	-- Update banner colors
	TweenService:Create(eventBanner,
		TweenInfo.new(0.5),
		{ BackgroundColor3 = colors.primary }
	):Play()

	eventGradient.Color = ColorSequence.new(colors.primary, colors.secondary)
	glowContainer.BackgroundColor3 = colors.glow

	-- Update scope badge
	if scope == "global" then
		scopeLabel.Text = "üåç GLOBAL"
		TweenService:Create(scopeBadge,
			TweenInfo.new(0.3),
			{ Size = UDim2.new(0, 110, 0, 26) }
		):Play()
	else
		scopeLabel.Text = "üñ•Ô∏è LOCAL"
		TweenService:Create(scopeBadge,
			TweenInfo.new(0.3),
			{ Size = UDim2.new(0, 100, 0, 26) }
		):Play()
	end
end

local function updateEventBanner()
	if eventState.active then
		local remain = math.max(0, eventState["end"] - eventState.now)
		local totalDuration = eventState["end"] - eventState.start
		local progress = totalDuration > 0 and (1 - remain / totalDuration) or 0

		-- Update text
		summitLabel.Text = "‚õ∞Ô∏è Summit x" .. cleanNum(eventState.summitMult)
		cashLabel.Text = "üí∞ Cash x" .. cleanNum(eventState.cashMult)
		timerLabel.Text = formatTime(remain)

		-- Update colors based on scope
		updateColors(eventState.scope)

		-- Update progress bar
		TweenService:Create(progressBar,
			TweenInfo.new(0.5),
			{ Size = UDim2.new(progress, 0, 0, 3) }
		):Play()

		-- Change timer color based on remaining time
		if remain < 60 then
			timerLabel.TextColor3 = Color3.fromRGB(239, 68, 68) -- Red
			timerIcon.Text = "‚ö†Ô∏è"
		elseif remain < 300 then
			timerLabel.TextColor3 = Color3.fromRGB(251, 146, 60) -- Orange
			timerIcon.Text = "‚è∞"
		else
			timerLabel.TextColor3 = Color3.new(1, 1, 1) -- White
			timerIcon.Text = "‚è±Ô∏è"
		end

		slideEventIn()
	else
		slideEventOut()
	end
end

-- ==== Initialize ====
local function initializeEventState()
	local ok, result = pcall(function()
		return GetEventStatusRF:InvokeServer()
	end)

	if ok and typeof(result) == "table" then
		eventState = result
		updateEventBanner()

		if eventState.active then
			local scopeText = eventState.scope == "global" and "Global Event" or "Local Event"
			print("[EventBanner] " .. scopeText .. " active - Summit x" .. cleanNum(eventState.summitMult) .. ", Cash x" .. cleanNum(eventState.cashMult))
		end
	end
end

-- Initialize on load
task.spawn(initializeEventState)

-- ==== Event Listeners ====
EventChangedRE.OnClientEvent:Connect(function(data)
	if typeof(data) ~= "table" then return end

	eventState = data
	updateEventBanner()

	-- Show notification when event changes
	if data.active then
		local scopeText = data.scope == "global" and "üåç Global Event Started!" or "üñ•Ô∏è Local Event Started!"
		local message = string.format("%s\n‚õ∞Ô∏è Summit x%s ‚Ä¢ üí∞ Cash x%s", 
			scopeText, cleanNum(data.summitMult), cleanNum(data.cashMult))

		-- Show via toast if available
		if _G.Toast then
			_G.Toast.success(message, 5)
		end
	else
		if _G.Toast then
			_G.Toast.info("Event Ended", 3)
		end
	end
end)

-- Announcement listener
if AnnouncementRE then
	AnnouncementRE.OnClientEvent:Connect(function(payload)
		if typeof(payload) ~= "table" then return end

		local text = tostring(payload.text or "")
		local style = tostring(payload.style or "info")
		local duration = tonumber(payload.duration) or 4

		-- Set colors based on style
		local color = CONFIG.COLORS.announcement[style] or CONFIG.COLORS.announcement.info
		announcementGradient.Color = ColorSequence.new(color, color)

		-- Set icon based on style
		local icons = {
			success = "‚úì",
			warning = "‚ö†Ô∏è",
			error = "‚úï",
			info = "üì¢"
		}
		announcementIcon.Text = icons[style] or "üì¢"

		announcementLabel.Text = text

		slideAnnouncementIn()

		task.delay(duration, function()
			slideAnnouncementOut()
		end)
	end)
end

-- ==== Countdown Loop ====
task.spawn(function()
	while true do
		task.wait(CONFIG.UPDATE_INTERVAL)

		if eventState.active then
			eventState.now = eventState.now + CONFIG.UPDATE_INTERVAL

			if eventState.now >= eventState["end"] then
				eventState.active = false
				updateEventBanner()
			else
				updateEventBanner()
			end
		end
	end
end)

print("[EventBanner] Enhanced Event Banner System loaded successfully!")