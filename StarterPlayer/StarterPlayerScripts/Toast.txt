-- Toast.client.lua local script
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

local UIEvents = ReplicatedStorage:WaitForChild("UIEvents")
local ToastEvent = UIEvents:WaitForChild("Toast")

-- ==== Configuration ====
local CONFIG = {
	COLORS = {
		success = {
			primary = Color3.fromRGB(34, 197, 94),
			secondary = Color3.fromRGB(22, 163, 74),
			bg = Color3.fromRGB(20, 83, 45)
		},
		error = {
			primary = Color3.fromRGB(239, 68, 68),
			secondary = Color3.fromRGB(220, 38, 38),
			bg = Color3.fromRGB(127, 29, 29)
		},
		warning = {
			primary = Color3.fromRGB(251, 146, 60),
			secondary = Color3.fromRGB(249, 115, 22),
			bg = Color3.fromRGB(154, 52, 18)
		},
		info = {
			primary = Color3.fromRGB(59, 130, 246),
			secondary = Color3.fromRGB(37, 99, 235),
			bg = Color3.fromRGB(30, 58, 138)
		}
	},
	ICONS = {
		success = "✓",
		error = "✕",
		warning = "⚠",
		info = "ℹ"
	},
	POSITIONS = {
		top = UDim2.new(0.5, 0, 0.05, 0),
		bottom = UDim2.new(0.5, 0, 0.95, 0),
		["top-right"] = UDim2.new(0.98, 0, 0.05, 0),
		["bottom-right"] = UDim2.new(0.98, 0, 0.95, 0)
	},
	DEFAULT_DURATION = 3,
	PADDING = 12,
	MAX_WIDTH = 400,
	ANIMATION_SPEED = 0.3
}

-- ==== Main GUI ====
local gui = Instance.new("ScreenGui")
gui.Name = "EnhancedToastUI"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = player:WaitForChild("PlayerGui")

local container = Instance.new("Frame")
container.Name = "ToastContainer"
container.AnchorPoint = Vector2.new(0.5, 0)
container.Position = CONFIG.POSITIONS.top
container.Size = UDim2.new(0, CONFIG.MAX_WIDTH, 0, 0)
container.BackgroundTransparency = 1
container.Parent = gui

local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, CONFIG.PADDING)
listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
listLayout.Parent = container

-- ==== Helper Functions ====
local function createCorner(parent, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius or 12)
	corner.Parent = parent
	return corner
end

local function createGradient(parent, color1, color2, rotation)
	local gradient = Instance.new("UIGradient")
	gradient.Color = ColorSequence.new(color1, color2)
	gradient.Rotation = rotation or 90
	gradient.Parent = parent
	return gradient
end

local function createShadow(parent)
	local shadow = Instance.new("ImageLabel")
	shadow.Name = "Shadow"
	shadow.AnchorPoint = Vector2.new(0.5, 0.5)
	shadow.Position = UDim2.new(0.5, 0, 0.5, 2)
	shadow.Size = UDim2.new(1, 30, 1, 30)
	shadow.BackgroundTransparency = 1
	shadow.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
	shadow.ImageColor3 = Color3.new(0, 0, 0)
	shadow.ImageTransparency = 0.7
	shadow.ZIndex = parent.ZIndex - 1
	shadow.Parent = parent
	return shadow
end

-- ==== Toast Item Creation ====
local toastIndex = 0

local function createToastItem(data)
	toastIndex = toastIndex + 1

	-- Parse data
	local text = (typeof(data) == "table" and data.text) or tostring(data)
	local kind = (typeof(data) == "table" and data.kind) or "info"
	local duration = (typeof(data) == "table" and data.duration) or CONFIG.DEFAULT_DURATION
	local dismissible = (typeof(data) == "table" and data.dismissible ~= false) or true

	-- Validate kind
	if not CONFIG.COLORS[kind] then kind = "info" end

	local colorScheme = CONFIG.COLORS[kind]

	-- Main container
	local toast = Instance.new("Frame")
	toast.Name = "Toast_" .. toastIndex
	toast.Size = UDim2.new(1, 0, 0, 70)
	toast.BackgroundColor3 = colorScheme.bg
	toast.BackgroundTransparency = 0.15
	toast.BorderSizePixel = 0
	toast.LayoutOrder = toastIndex
	toast.ClipsDescendants = true

	createCorner(toast, 12)
	createGradient(toast, colorScheme.primary, colorScheme.secondary, 45)

	-- Stroke
	local stroke = Instance.new("UIStroke")
	stroke.Color = colorScheme.primary
	stroke.Thickness = 2
	stroke.Transparency = 0.5
	stroke.Parent = toast

	-- Content container
	local content = Instance.new("Frame")
	content.Size = UDim2.new(1, -24, 1, -24)
	content.Position = UDim2.new(0, 12, 0, 12)
	content.BackgroundTransparency = 1
	content.Parent = toast

	-- Icon
	local icon = Instance.new("TextLabel")
	icon.Size = UDim2.new(0, 40, 0, 40)
	icon.Position = UDim2.new(0, 0, 0, 3)
	icon.BackgroundColor3 = colorScheme.primary
	icon.BackgroundTransparency = 0.3
	icon.Text = CONFIG.ICONS[kind] or "ℹ"
	icon.Font = Enum.Font.GothamBold
	icon.TextSize = 24
	icon.TextColor3 = Color3.new(1, 1, 1)
	icon.Parent = content
	createCorner(icon, 20)

	-- Text label
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, dismissible and -90 or -50, 1, 0)
	label.Position = UDim2.new(0, 50, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamMedium
	label.TextSize = 14
	label.TextColor3 = Color3.new(1, 1, 1)
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.TextYAlignment = Enum.TextYAlignment.Top
	label.TextWrapped = true
	label.Parent = content

	-- Close button (if dismissible)
	local closeBtn
	if dismissible then
		closeBtn = Instance.new("TextButton")
		closeBtn.Size = UDim2.new(0, 32, 0, 32)
		closeBtn.Position = UDim2.new(1, -32, 0, 4)
		closeBtn.BackgroundColor3 = Color3.new(1, 1, 1)
		closeBtn.BackgroundTransparency = 0.8
		closeBtn.Text = "✕"
		closeBtn.Font = Enum.Font.GothamBold
		closeBtn.TextSize = 16
		closeBtn.TextColor3 = Color3.new(1, 1, 1)
		closeBtn.Parent = content
		createCorner(closeBtn, 16)

		-- Hover effect
		closeBtn.MouseEnter:Connect(function()
			TweenService:Create(closeBtn, TweenInfo.new(0.2), {
				BackgroundTransparency = 0.6
			}):Play()
		end)

		closeBtn.MouseLeave:Connect(function()
			TweenService:Create(closeBtn, TweenInfo.new(0.2), {
				BackgroundTransparency = 0.8
			}):Play()
		end)
	end

	-- Progress bar
	local progressContainer = Instance.new("Frame")
	progressContainer.Size = UDim2.new(1, 0, 0, 3)
	progressContainer.Position = UDim2.new(0, 0, 1, -3)
	progressContainer.BackgroundColor3 = Color3.new(0, 0, 0)
	progressContainer.BackgroundTransparency = 0.6
	progressContainer.BorderSizePixel = 0
	progressContainer.Parent = toast

	local progressBar = Instance.new("Frame")
	progressBar.Size = UDim2.new(1, 0, 1, 0)
	progressBar.BackgroundColor3 = colorScheme.primary
	progressBar.BorderSizePixel = 0
	progressBar.Parent = progressContainer

	-- Animation data
	local startTime = os.clock()
	local dismissed = false

	-- Dismiss function
	local function dismiss()
		if dismissed then return end
		dismissed = true

		-- Fade out animation
		local fadeOut = TweenService:Create(toast, 
			TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
			{
				BackgroundTransparency = 1,
				Position = UDim2.new(0, -20, 0, toast.Position.Y.Offset)
			}
		)

		TweenService:Create(stroke, TweenInfo.new(CONFIG.ANIMATION_SPEED), {
			Transparency = 1
		}):Play()

		TweenService:Create(label, TweenInfo.new(CONFIG.ANIMATION_SPEED), {
			TextTransparency = 1
		}):Play()

		TweenService:Create(icon, TweenInfo.new(CONFIG.ANIMATION_SPEED), {
			BackgroundTransparency = 1,
			TextTransparency = 1
		}):Play()

		if closeBtn then
			TweenService:Create(closeBtn, TweenInfo.new(CONFIG.ANIMATION_SPEED), {
				BackgroundTransparency = 1,
				TextTransparency = 1
			}):Play()
		end

		fadeOut:Play()
		fadeOut.Completed:Connect(function()
			toast:Destroy()
		end)
	end

	-- Close button click
	if closeBtn then
		closeBtn.MouseButton1Click:Connect(dismiss)
	end

	-- Click to dismiss
	if dismissible then
		local clickButton = Instance.new("TextButton")
		clickButton.Size = UDim2.new(1, 0, 1, 0)
		clickButton.BackgroundTransparency = 1
		clickButton.Text = ""
		clickButton.ZIndex = toast.ZIndex - 1
		clickButton.Parent = toast

		clickButton.MouseButton1Click:Connect(dismiss)
	end

	-- Auto dismiss after duration
	task.spawn(function()
		local elapsed = 0
		while elapsed < duration and not dismissed do
			elapsed = os.clock() - startTime
			local progress = math.clamp(1 - (elapsed / duration), 0, 1)
			progressBar.Size = UDim2.new(progress, 0, 1, 0)
			task.wait(0.03)
		end

		if not dismissed then
			dismiss()
		end
	end)

	return toast
end

-- ==== Queue System ====
local queue = {}
local isShowing = false
local maxConcurrent = 5
local activeToasts = 0

local function updateLayout()
	container.Size = UDim2.new(0, CONFIG.MAX_WIDTH, 0, listLayout.AbsoluteContentSize.Y)
end

local function showNext()
	if #queue == 0 or activeToasts >= maxConcurrent then return end

	local data = table.remove(queue, 1)
	local toast = createToastItem(data)

	-- Set initial state
	toast.Position = UDim2.new(0, 0, 0, -100)
	toast.BackgroundTransparency = 1

	toast.Parent = container
	activeToasts = activeToasts + 1

	-- Entrance animation
	task.wait(0.05)

	local entranceTween = TweenService:Create(toast,
		TweenInfo.new(CONFIG.ANIMATION_SPEED, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
		{
			Position = UDim2.new(0, 0, 0, 0),
			BackgroundTransparency = 0.15
		}
	)
	entranceTween:Play()

	-- Update container size
	updateLayout()

	-- Wait for toast to be destroyed
	toast.Destroying:Connect(function()
		activeToasts = activeToasts - 1
		updateLayout()
		showNext()
	end)

	-- Show next toast after small delay
	task.delay(0.1, showNext)
end

local function pushToast(data)
	table.insert(queue, data)
	showNext()
end

-- ==== Event Listeners ====
ToastEvent.OnClientEvent:Connect(function(payload)
	pushToast(payload)
end)

-- ==== Public API (for local calls) ====
_G.Toast = {
	show = function(text, kind, duration)
		pushToast({
			text = text,
			kind = kind or "info",
			duration = duration or CONFIG.DEFAULT_DURATION
		})
	end,

	success = function(text, duration)
		pushToast({text = text, kind = "success", duration = duration})
	end,

	error = function(text, duration)
		pushToast({text = text, kind = "error", duration = duration})
	end,

	warning = function(text, duration)
		pushToast({text = text, kind = "warning", duration = duration})
	end,

	info = function(text, duration)
		pushToast({text = text, kind = "info", duration = duration})
	end,

	setPosition = function(position)
		if CONFIG.POSITIONS[position] then
			container.Position = CONFIG.POSITIONS[position]

			if position:find("bottom") then
				container.AnchorPoint = Vector2.new(0.5, 1)
				listLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
			else
				container.AnchorPoint = Vector2.new(0.5, 0)
				listLayout.VerticalAlignment = Enum.VerticalAlignment.Top
			end
		end
	end
}

-- ==== Initialize ====
print("[Toast] Enhanced Toast System loaded successfully!")

-- Test toasts (remove in production)
--[[
task.wait(2)
_G.Toast.success("Connection successful!", 3)
task.wait(0.5)
_G.Toast.info("Loading game data...", 3)
task.wait(0.5)
_G.Toast.warning("High ping detected", 3)
]]